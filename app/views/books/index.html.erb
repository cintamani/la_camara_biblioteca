<div class="books-header">
  <h1>Archivo de Libros</h1>

  <% if logged_in? %>
    <div class="header-actions">
      <%= link_to "Añadir Libro", new_book_path, class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<div class="search-section">
  <%= form_with url: books_path, method: :get, class: "search-form" do |form| %>
    <div class="search-fields">
      <div class="form-group">
        <%= form.text_field :search,
            value: params[:search],
            placeholder: "Buscar por título, autor o ISBN..." %>
      </div>

      <div class="form-group">
        <%= form.select :genre, grouped_genre_options(@parent_genres, params[:genre]) %>
      </div>

      <%= form.submit "Buscar", class: "btn btn-secondary" %>

      <% if params[:search].present? || params[:genre].present? %>
        <%= link_to "Limpiar", books_path, class: "btn btn-link" %>
      <% end %>
    </div>
  <% end %>
</div>

<% if @books.any? %>
  <div class="books-count">
    Mostrando <%= @pagy.from %>-<%= @pagy.to %> de <%= @pagy.count %> <%= @pagy.count == 1 ? "libro" : "libros" %>
  </div>
  <div class="books-list">
    <% @books.each do |book| %>
      <div class="book-card">
        <div class="book-info">
          <h2><%= link_to book.title, book %></h2>

          <% if book.author.present? %>
            <p class="author">por <%= link_to book.author, books_path(search: book.author) %></p>
          <% end %>

          <% if book.isbns.present? && book.isbns.any? %>
            <p class="isbn">
              <%= book.isbns.count == 1 ? "ISBN" : "ISBNs" %>:
              <%= book.isbns_display %>
            </p>
          <% end %>

          <% if book.genres.any? %>
            <div class="genres">
              <% book.genres.each do |genre| %>
                <%= link_to genre.name,
                    books_path(genre: genre.name),
                    class: "genre-tag" %>
              <% end %>
            </div>
          <% end %>
        </div>

        <% if logged_in? %>
          <div class="book-actions">
            <%= link_to "Editar", edit_book_path(book), class: "btn btn-small" %>

            <%= button_to "Eliminar", book,
                method: :delete,
                class: "btn btn-small btn-danger",
                data: { turbo_confirm: "¿Estás seguro de que quieres eliminar este libro?" } %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="pagination-container">
    <%== pagy_nav(@pagy) if @pagy.pages > 1 %>
  </div>
<% else %>
  <div class="empty-state">
    <p>No se encontraron libros en el archivo.</p>

    <% if params[:search].present? || params[:genre].present? %>
      <p>
        Intenta ajustar los criterios de búsqueda o
        <%= link_to "ver todos los libros", books_path %>.
      </p>
    <% elsif logged_in? %>
      <p>
        <%= link_to "Añade tu primer libro", new_book_path %> para comenzar.
      </p>
    <% end %>
  </div>
<% end %>
